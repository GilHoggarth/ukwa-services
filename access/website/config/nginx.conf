limit_req_zone $request_uri zone=by_uri:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=by_ip:1m rate=30r/m;
limit_req_zone $http_x_forwarded_for zone=by_remote_ip:10m rate=6r/m;

server {
    listen 80;
    proxy_read_timeout 600;

    # NGINX merging // to / routinely causes problems for us, so lets switch it off:
    merge_slashes off;

    # rewrites to be processed before locations -----------------------------------
    rewrite /act/userguide https://github.com/ukwa/w3act/wiki/W3ACT-User-Guide;
    
    # Digital monuments and memory http://xclacksoverhead.org/
    add_header X-Clacks-Overhead "GNU Terry Pratchett";

    # proxies -----------------------------------------------------------
    location /wayback/ {
            rewrite ^/wayback/(.*) /$1 break;

            include uwsgi_params;
            uwsgi_param UWSGI_SCHEME $http_x_forwarded_proto;
            uwsgi_param HOST $host;
            uwsgi_param SCRIPT_NAME /wayback;

            uwsgi_pass pywb:8081;

            uwsgi_force_ranges on;

            uwsgi_buffer_size 64k;
            uwsgi_buffers 16 64k;
            uwsgi_busy_buffers_size 64k;

            uwsgi_request_buffering off;
            uwsgi_buffering off;
    }


    location /mementos {
        proxy_pass http://mementos:9000;
    }
    location /mementos/search {
        limit_req zone=by_remote_ip burst=10;

        # A hack to stop it re-writing double-slashes in the URI!
        if ($request_uri ~* "/mementos/search/(.*)$") {
          proxy_pass    http://mementos:9000/mementos/search/$1;
        }

        proxy_pass http://mementos:9000;
    }

    location /shine {
        proxy_pass http://shine:9000;
    }

    #location /interject {
    #        proxy_pass      http://interject:9000/interject;
    #}

    location /api {
        # Don't re-write double-slashes etc:
        if ($request_uri ~* "/(.*)") {
            proxy_pass http://api:8000/$1;
        }
        # Other parameters are set by the edge proxy:
        proxy_set_header X-Forwarded-Path /api/;
        proxy_pass      http://api:8000/api;
    }

    # rewrites -----------------------------------
    # collection shortcuts
    rewrite ^/avianflu(.*)$ /en/ukwa/collection/2446 permanent;
    rewrite ^/col/c8275.html /en/ukwa/collection/2446 permanent;
    rewrite ^/ukwa/collection/116179/page/1(.*)$ /en/ukwa/collection/2446 permanent;
    rewrite ^/edinburgh?transport(.*)$ /en/ukwa/collection/2379 permanent;
    rewrite ^/col/c8075.html /en/ukwa/collection/2379 permanent;
    rewrite ^/ElectionUK05(.*)$ /en/ukwa/collection/2453 permanent;
    rewrite ^/col/c8100.html /en/ukwa/collection/2453 permanent;
    rewrite ^/ukwa/collection/99035/page/1(.*)$ /en/ukwa/collection/2453 permanent;
    rewrite ^/G805(.*)$ /en/ukwa/collection/2398 permanent;
    rewrite ^/col/c8150.html /en/ukwa/collection/2398 permanent;
    rewrite ^/illness(.*)$ /en/ukwa/collection/2443 permanent;
    rewrite ^/col/c8200.html /en/ukwa/collection/2443 permanent;
    rewrite ^/latinamericauk(.*)$ /en/ukwa/collection/2384 permanent;
    rewrite ^/col/c8225.html /en/ukwa/collection/2384 permanent;
    rewrite ^/ukwa/collection/119539/page/1(.*)$ /en/ukwa/collection/2384 permanent;
    rewrite ^/londonJuly05(.*)$ /en/ukwa/collection/2439 permanent;
    rewrite ^/col/c8125.html /en/ukwa/collection/2439 permanent;
    rewrite ^/ukwa/collection/100757/page/1(.*)$ /en/ukwa/collection/2439 permanent;
    rewrite ^/col/$ /en/ukwa/collection permanent;
    rewrite ^/col/countryside(.*)$ /en/ukwa/collection/2429 permanent;
    rewrite ^/col/c8301.html /en/ukwa/collection/2429 permanent;
    rewrite ^/ukwa/collection/110213/page/1(.*)$ /en/ukwa/collection/2429 permanent;
    rewrite ^/col/tsunami(.*)$ /en/ukwa/collection/2435 permanent;
    rewrite ^/col/c8050.html /en/ukwa/collection/2435 permanent;
    rewrite ^/ukwa/collection/99326/page/1(.*)$ /en/ukwa/collection/2435 permanent;
    rewrite ^/quaker(.*)$ /en/ukwa/collection/2436 permanent;
    rewrite ^/women(.*)$ /en/ukwa/collection/2447 permanent;
    rewrite ^/col/c8175.html /en/ukwa/collection/2447 permanent;
    rewrite ^/ukwa/collection/98537/page/1(.*)$ /en/ukwa/collection/2447 permanent;
    rewrite ^/ukwa/collection/dummy/page/1(.*)$ /en/ukwa/collection/2450 permanent;
    rewrite ^/ukwa/collection/28180520/page/1(.*)$ /en/ukwa/collection/2450 permanent;
    rewrite ^/nominate /en/ukwa/info/nominate permanent;
    rewrite ^/cy/nominate /cy/ukwa/info/nominate permanent;

    # internal
#       rewrite ^/wayback/memento/timegate/(.+)$ /wayback/archive/$1 permanent;
#       rewrite ^/waybacktg/ore/(.*)$ /wayback/list/$1 permanent;
    # Endpoint for Resolve API service used by Document Harvester:
    rewrite ^/access/resolve/(.*)$ /api/query/resolve/$1 permanent;

    # external
    rewrite ^/blog(.*)$ http://britishlibrary.typepad.co.uk/webarchive permanent;
    rewrite ^/smashfest.*$ http://goo.gl/forms/o35mRmzwLl permanent;
    rewrite ^/video(.*)$ https://www.youtube.com/channel/UCJukhTSw8VRj-VNTpBcqWkw/videos permanent;

    
    # Hook in the dataset volume:
    location /datasets {
            root /var/www/html;
            disable_symlinks off;
            autoindex on;
    }

    # 404 image randomiser:
    location /404 {
            root /var/www/ukwa-site/static/img;
            random_index on;
    }

    # Patch in static robots.txt etc.
    location / {
	root /webroot;
        try_files $uri @ukwaui;
    }

    # default action - always last ---------------
    location @ukwaui {
            proxy_pass      		http://ukwa-ui:8080;
	    proxy_set_header		Host	$host;
            proxy_connect_timeout      	300s;
            proxy_read_timeout      	300s;
            proxy_send_timeout      	300s;
    }

}
