# -------------------------------------------------------------
# This service configuration defines our main public website access stack.
# -------------------------------------------------------------

version: '3.2'

services:
  # -------------------------------------------------------------
  # Get W3ACT data from HDFS and generate derivatives
  # -------------------------------------------------------------
  w3act_export:
    image: ukwa/python-w3act
    command: "/w3act_export_scripts/export.sh"
    volumes:
        - "./w3act_export_scripts:/w3act_export_scripts"
        - "w3act_export:/w3act_export"

  # -------------------------------------------------------------
  # Collections index for Topics & Themes of the UKWA UI
  # -------------------------------------------------------------
  ukwa_collections:
    image: ukwa/ukwa-ui-collections-solr
    ports:
        - "9021:8983" # Exposed port so external clients can read/populate

  # ----------------------------------------------------------------------
  # Analyses recent crawl behaviour by processing the crawled data stream:
  # ----------------------------------------------------------------------
  analyse:
    image: ukwa/crawl-streams
    command: "analyse -k ${KAFKA_BROKER} -u 2 -o /analysis/fc.crawled.json"
    volumes:
      - "fc_analysis:/analysis"

# Volumes and networks supporting the above
# -----------------------------------------
volumes:
  # Used to store the exported W3ACT data.
  w3act_export:
    driver: local
    driver_opts:
      type: none
      device: ${STORAGE_PATH}/w3act_export
      o: bind

  # Used to store analysis generated from Kafka, so it can be made available via the API component.
  # Only transient storage so can be managed entirely by Docker.
  fc_analysis:
    driver: local
    driver_opts:
      type: none
      device: ${STORAGE_PATH}/fc_analysis
      o: bind

